<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Texas Map - Highlighted Counties</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .county-label { color:#111; text-shadow:1px 1px 2px #fff; font-weight:600; font-size:10px; text-align:center; }
    .legend { position: absolute; bottom: 10px; left: 10px; background: #fff; padding: 8px 10px; border-radius: 6px; box-shadow: 0 1px 5px rgba(0,0,0,.3); font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .legend .swatch { display:inline-block; width:12px; height:12px; margin-right:6px; vertical-align:middle; border:1px solid #444; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script>
    // ---- lists (normalized, typos fixed: DeWitt, Matagorda) ----
    const BATCH1 = [
      "McLennan","Falls","Robertson","Bell","Milam","Brazos","Grimes","Burleson","Lee",
      "Williamson","Bastrop","Travis","Washington","Waller","Austin","Fayette","Hays",
      "Caldwell","Harris","Comal","Guadalupe","Gonzales","Lavaca","Colorado","Fort Bend",
      "Burnet","Walker"
    ];
    const BATCH2 = [
      "Chambers","Liberty","San Jacinto","Walker","Montgomery","Madison","Leon","Limestone",
      "Hill","Bosque","Coryell","Lampasas","San Saba","Llano","Blanco","Kendall","Bexar",
      "Wilson","Karnes","DeWitt","Jackson","Victoria","Wharton","Brazoria","Matagorda","Galveston","De Witt"
    ];

    const toKey = s => (s || '').trim().toLowerCase();
    const batch1Set = new Set(BATCH1.map(toKey));
    const batch2Set = new Set(BATCH2.map(toKey));

    // ---- map ----
    const map = L.map('map').setView([31, -99], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'Â© OpenStreetMap contributors', maxZoom: 11, minZoom: 5
    }).addTo(map);

    // outline
    fetch('assets/landcalculator/texas_outline_topo.json')
      .then(r=>r.json())
      .then(topo=>{
        const geo = topojson.feature(topo, topo.objects[Object.keys(topo.objects)[0]]);
        L.geoJSON(geo, { style:{ color:'#000', weight:2, fill:false } }).addTo(map);
      });

    // counties + styling
    fetch('assets/landcalculator/txdot_counties_topo.json')
      .then(r=>r.json())
      .then(topo=>{
        const geo = topojson.feature(topo, topo.objects[Object.keys(topo.objects)[0]]);
        const countiesLayer = L.geoJSON(geo, {
          style: feature => {
            const name = toKey(feature.properties.CNTY_NM);
            if (batch2Set.has(name)) return { color:'#444', weight:1, fillColor:'#2ecc71', fillOpacity:0.5 }; // green
            if (batch1Set.has(name)) return { color:'#444', weight:1, fillColor:'#ffd60a', fillOpacity:0.5 }; // yellow
            return { color:'#555', weight:1, fillColor:'#f2f2f2', fillOpacity:0.6 }; // default
          },
          onEachFeature: (feature, layer) => {
            const name = feature.properties.CNTY_NM || 'Unknown';
            layer.bindPopup(`<strong>${name} County</strong>`);
          }
        }).addTo(map);

        // labels (show from zoom >= 7)
        const labelMarkers = [];
        countiesLayer.eachLayer(layer=>{
          const name = layer.feature.properties.CNTY_NM || '';
          const center = layer.getBounds().getCenter();
          const label = L.divIcon({ className:'county-label', html: name });
          labelMarkers.push(L.marker(center, { icon: label, interactive:false }));
        });
        const labelGroup = L.layerGroup().addTo(map);

        const updateLabels = () => {
          labelGroup.clearLayers();
          const z = map.getZoom();
          const size = Math.max(8, z * 1.2);
          document.querySelectorAll('.county-label').forEach(el => el.style.fontSize = `${size}px`);
          if (z >= 7) labelMarkers.forEach(m => labelGroup.addLayer(m));
        };
        map.on('zoomend', updateLabels);
        updateLabels();
      });

    // legend
    const legend = L.control({position:'bottomleft'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div><span class="swatch" style="background:#ffd60a"></span>Batch 1</div>
        <div><span class="swatch" style="background:#2ecc71"></span>Batch 2</div>`;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
